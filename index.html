<html>
  <head>
  <title>Generating fantasy maps, on a globe</title>
    <style>
      body{
      margin: 0px auto;
      width:900px;
      font-size:1.5em;
      }
      p{
      margin-block-start: 0;
      }
      h1,h2,h3,h4,h5,h6{
      text-align:center;
      margin-block-start: 0;
      }
      pre
      {
      overflow-x: auto;
      }
      .step
      {
      background-color:#eee;
      margin:.5em;
      padding:.5em;
      clear:both;
      overflow:auto;
      }
      canvas, svg{
      background-color:white;
      border: thin black solid;
      width:320px;
      height:200px;
      display:inline-block;
      }
      button{
      margin:.5em;
      padding:.5em;
      font-size: large;
      border-radius: .5rem;
      background-color: white;
      }
      .actions{
      display:inline-block;
      white-space: pre-wrap;
      vertical-align: top;
      }
      .usage
      {
      display:inline;
      }
      code{
      font-size: .8em;
    background-color: #F7F7F7;
    margin: 0;
    padding: 0;
    }
    </style>
    <!-- keep track of the state of the world, but no UI logic -->
    <script src="terrain.js"></script>
    <!-- interacts with the browner to draw, has an internal terrain object -->
    <script src="terrainUI.js"></script>
    <!-- comman javascript library -->
    <script src="https://d3js.org/d3.v4.js"></script>
    <script src="https://d3js.org/d3-array.v1.min.js"></script>
    <!-- map projection support -->
    <script src="https://d3js.org/d3-geo.v1.min.js"></script>
    <!-- more map projection support -->
    <script src="https://d3js.org/d3-geo-projection.v2.min.js"></script>
    <!-- library for computing voronoi diargrams and delaunay traingualations, prerequesite for  d3-geo-voronoi-->
    <script src="https://unpkg.com/d3-delaunay@5"></script>
    <!-- support for spherical delaunay data -->
    <script src="https://unpkg.com/d3-geo-voronoi@1.6.0/dist/d3-geo-voronoi.js"></script>
    <!-- support for contour functionality -->
    <script src="https://unpkg.com/d3-tricontour@0.1.0"></script>
    <!-- support for zoom and panning -->
    <script src="https://unpkg.com/d3-geo-zoom"></script>
    <!-- psudo random number generator that is seedable, nice for being able to reproduce issues -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/seedrandom/3.0.5/seedrandom.min.js"></script>
    <!-- help to syntax highlight code thats on the screen -->
    <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js"></script>
    
  </head>
  <body >
    <h1>Generating fantasy maps, on a globe</h1>
    <h3>Inspiration</h3>
    <p>
      I love making maps, and filling them up with stuff, and making stuff evolve organically, but its always overwhelming past the first few things. 
      When I found Martin O'Leary's <a href="http://mewo2.com/notes/terrain/">Generating fantasy maps</a>, I couldn't resist trying to take it a couple steps farther. 
      Flat, bounded maps always bothered me, worlds are round, baring special physics/science/technology, so lets put stuff on a globe instead of a flat plane!
    </p>
    <p>But I sometimes can't help redesigning the wheel, and chose to use canvas instead of svg for reasons, mostly performance, which requires rewiring all the d3 code that produces the images. And, I wanted to make globes, not just flat maps, which requires rewiring the algebra.</p>
    
    <div class="a">
      <div class="step" >
        <h4>Boilerplate stuff</h4>
        <h5>Libraries</h5>
        <pre class="prettyprint"><code>&#x3C;!-- keep track of the state of the world, but no UI logic --&#x3E;
&#x3C;script src=&#x22;terrain.js&#x22;&#x3E;&#x3C;/script&#x3E;
&#x3C;!-- interacts with the browner to draw, has an internal terrain object --&#x3E;
&#x3C;script src=&#x22;terrainUI.js&#x22;&#x3E;&#x3C;/script&#x3E;
&#x3C;!-- comman javascript library --&#x3E;
&#x3C;script src=&#x22;https://d3js.org/d3.v4.js&#x22;&#x3E;&#x3C;/script&#x3E;
&#x3C;script src=&#x22;https://d3js.org/d3-array.v1.min.js&#x22;&#x3E;&#x3C;/script&#x3E;
&#x3C;!-- map projection support --&#x3E;
&#x3C;script src=&#x22;https://d3js.org/d3-geo.v1.min.js&#x22;&#x3E;&#x3C;/script&#x3E;
&#x3C;!-- more map projection support --&#x3E;
&#x3C;script src=&#x22;https://d3js.org/d3-geo-projection.v2.min.js&#x22;&#x3E;&#x3C;/script&#x3E;
&#x3C;!-- library for computing voronoi diargrams and delaunay traingualations, prerequesite for  d3-geo-voronoi--&#x3E;
&#x3C;script src=&#x22;https://unpkg.com/d3-delaunay@5&#x22;&#x3E;&#x3C;/script&#x3E;
&#x3C;!-- support for spherical delaunay data --&#x3E;
&#x3C;script src=&#x22;https://unpkg.com/d3-geo-voronoi@1.6.0/dist/d3-geo-voronoi.js&#x22;&#x3E;&#x3C;/script&#x3E;
&#x3C;!-- psudo random number generator that is seedable, nice for being able to reproduce issues --&#x3E;
&#x3C;script src=&#x22;https://cdnjs.cloudflare.com/ajax/libs/seedrandom/3.0.5/seedrandom.min.js&#x22;&#x3E;&#x3C;/script&#x3E;</code>
</pre>
        <p>Add the drawing element, canvas for my purposes, and initialize the ui wrapper so we can draw on the canvas later</p>
        <pre class="prettyprint"><code>&lt;canvas id=&quot;flatpoints&quot; width=&quot;320&quot; height=&quot;200&quot;&gt;&lt;/canvas&gt;
&lt;script&gt; var flatWorld=new TerrainUI(document.getElementById('flatpoints')); &lt;/script&gt;</code>
</pre>
      </div>
    </div>
    
    <!--points map-->
    <div class="a">
      <div class="step" >
        <p>Generate some points on a flat, bounded plane</p>
        <canvas id="flatpoints" width="320" height="200"></canvas>
        <script>
          var flatWorld=new TerrainUI(document.getElementById('flatpoints'));
        </script>
        
        <div><button onclick="flatWorld.generateAndVisualizePointsFlat()">Generate Points</button>
        <pre class="usage prettyprint lang-js"><code>flatWorld.generateAndVisualizePointsFlat()</code></pre>
        <pre class="prettyprint lang-js"><code>this.generateAndVisualizePointsFlat = function() {
  this.terrain.generatePointsFlat();
  this.clear();
  this.visualizePointsFlat();
};</code></pre>
<pre class="prettyprint lang-js"><code>this.generatePointsFlat = function(n) {
  var n = n || 256;
  this.points = [];
  for (var i = 0; i < n; i++) {
    this.points.push([(myrng() - .5) * this.extent.width,
                      (myrng() - .5) * this.extent.height]);
  }
};</code></pre>
<pre class="prettyprint lang-js"><code>
this.visualizePointsFlat = function() {
      var ctx = this.canvas.getContext("2d");
      //console.log(this.terrain.mesh);
      this.terrain.points.forEach(function(p) {
        ctx.beginPath();
        ctx.arc((p[0] + .5) * $this.canvas.width, //center x
                (p[1] + .5) * $this.canvas.width, //center y
                2, //radius
                0,//start angle
                Math.PI * 2//end angle
                );
        ctx.stroke();
        ctx.fill();
        ctx.closePath();
      });
    };</code></pre>
    
</div>
        <span><button onclick="flatWorld.improveAndVisualizePointsFlat()">Improve Points</button><span>how to call</span><span>interesting code</span></span>
        
      </div>
    </div>
    
    
    <!--basic transformations with grid-->
    <div class="a">
      <div class="step">
        <p>Show the mesh instead of the points</p>
        <canvas id="basic" width="320" height="200" ></canvas>
        <script>
          var basic=new TerrainUI(document.getElementById('basic'));
        </script>
        <button onclick="basic.copyAndVisualizeTrianglesFlat(flatWorld)">Copy from Above</button>
        <button onclick="basic.generateAndVisualizeMeshFlat()">Generate Mesh</button>
        <br />
        <button onclick="basic.improveAndVisualizeMeshFlat()">Improve Mesh</button>
      </div>
    </div>
    
    
    <!--  globe projection using svg -->
    <div class="a">
      <div class="step">
        <p>All the documentation talks about how to use d3-geo with svg, so make sure we can get that working before switching to canvas</p>
        <svg id="svg" width="320" height="200"></svg>
      </div>
    </div>
    <script>
      var svg = d3.select("#svg");
      var width = svg.attr('width'), height = svg.attr('height');
      
      var projection = d3.geoWinkel3()
          .scale(width / 5.2)
          .translate([width / 2, height / 2])
          .precision(1);
      
      var path = d3.geoPath()
          .projection(projection);
      
      var g = svg.append("g");
      
      var graticule = d3.geoGraticule()
          .step([10, 10]);
      var border={'type':'Sphere'};
      
      
      g.append("path")
          .datum(graticule)
          .attr("class", "graticule")
          .attr("d", path)
          .style("fill", "none")
          .style("stroke", "#999");
      
      g.append("path")
      .datum(border)
      .attr("class", "border")
      .attr("d", path)
      .style("fill", "none")
      .style("stroke", "#000");
        
    </script>
    <!--globe projection using canvas-->
    <div class="a">
      <div class="step" >
        <p>Sphere Projection</p>
        <p style="float:left;">Now we need to figure out how to do the same thing with canvas</p>
        <canvas id="sphere" width="400" height="200" ></canvas>
        <script>
          //get the canvas
          var canvas = d3.select("#sphere");
          //get the context
          var context = canvas.node().getContext("2d");
          //get the size of the canvas
          var width = canvas.attr('width'), height = canvas.attr('height');
          //get the projection and initialize its size/scale/etc
          var projection = d3.geoWinkel3()//.fitSize([width,height])
              .scale(width / 6.4)
              .translate([width / 2, height / 2])
              .precision(1);
          //get the function that generates the d attribute from svg's line function, not directly usable for canvas
          var path = d3.geoPath().projection(projection).context(context);
          //get some meridians and parallels
          // Graticule
          var graticule = d3.geoGraticule()
               .step([10, 10]);
          
          context.beginPath();
          path(graticule());
          context.strokeStyle = "#999";
          context.stroke();
          
          var border={'type':'Sphere'};
          context.beginPath();
          path(border);
          context.strokeStyle = "#000";
          context.stroke();
        </script>
      </div>
    </div>
    <!--generate random points on a globe-->
    <div class="a">
      <div class="step" >
        <p>Sphere Random Points</p>
        <p style="float:left;"></p>
        <canvas id="sphere_random_points" width="320" height="200" ></canvas>
        <script>
          //get the canvas
          var canvas = d3.select("#sphere_random_points");      
          var sphere_random_points=new TerrainUI(canvas.node());
        </script>
        <button onclick="sphere_random_points.generateAndVisualizePointsAndBorder()">Generate Points</button>
        <button onclick="sphere_random_points.improveAndVisualizePointsAndBorder()">Improve Points</button>
      </div>
    </div>
    <!--show voronoi polygons-->
    <div class="a">
      <div class="step" >
        <p>Voronoi Shapes</p>
        <p style="float:left;"></p>
        <canvas id="sphere_voronoi" width="320" height="200"></canvas>
        <script>
          //get the canvas
          var canvas = d3.select("#sphere_voronoi");      
          var sphere_voronoi=new TerrainUI(canvas.node());
        </script>
        <button onclick="sphere_voronoi.copyAndVisualizeVoronoi(sphere_random_points)">Copy from Above</button>
        <button onclick="sphere_voronoi.generateAndVisualizeVoronoi()">Generate Points</button>
        <button onclick="sphere_voronoi.improveAndVisualizeVoronoi()">Improve Points</button>
      </div>
    </div>
    
    <!--triangles/voronoi-->
    <div class="a">
      <div class="step" >
        <p>Voronoi/Triangles</p>
        <p style="float:left;"></p>
        <canvas id="triangles_andor_polygons" width="320" height="200" ></canvas>
        <script>
          //get the canvas
          var triangles_andor_polygons=new TerrainUI(document.getElementById('triangles_andor_polygons'));
        </script>
        <button onclick="triangles_andor_polygons.copyAndVisualizeVoronoi(sphere_voronoi)">Copy from Above</button>
        <button onclick="triangles_andor_polygons.generateAndVisualizeVoronoi()">Generate Points</button>
        <button onclick="triangles_andor_polygons.improveAndVisualizeVoronoi()">Improve Points</button>
        <button onclick="triangles_andor_polygons.visualizeVoronoi()">Show Voronoi</button>
        <button onclick="triangles_andor_polygons.visualizeOriginalPoints()">Show Original Points</button>
        <button onclick="triangles_andor_polygons.visualizeVoronoiPoints()">Show Voronoi Points</button>
        <button onclick="triangles_andor_polygons.visualizeVoronoiEdges()">Show Voronoi Edges</button>
        <button onclick="triangles_andor_polygons.visualizeTriangles()">Show Triangles</button>
      </div>
    </div>

    <!--transformations, coast-->
    <div class="a">
      <div class="step" >
        <p>Transformations, Coast</p>
        <p style="float:left;"></p>
        <canvas id="transformations_coast" width="320" height="200" ></canvas>
        <script>
          //get the canvas
          var transformations_coast=new TerrainUI(document.getElementById('transformations_coast'));
        </script>
        <button onclick="transformations_coast.copyAndVisualizeHeightmap(triangles_andor_polygons)">Copy from Above</button>
        <button onclick="transformations_coast.generateAndVisualizeHeightmap()">Generate Good Points</button>
        <button onclick="transformations_coast.improveAndVisualizeHeightmap()">Improve Points</button>
        <button onclick="transformations_coast.addContinentAndVisualizeHeightmap(1)">Add one continents</button>
        <button onclick="transformations_coast.addIslandAndVisualizeHeightmap(5)">Add five islands</button>
        <button onclick="transformations_coast.setSeaLevelToMedianAndVisualizeHeightmap()">Set sea level to median</button>
        <button onclick="transformations_coast.visualizeCoast()">Draw Coast</button>
      </div>
    </div>
    
    <!--zoom, pan-->
    <div class="a">
      <div class="step" >
        <p>Zoom, Panning</p>
        <p style="float:left;"></p>
        <canvas id="zoompan" width="320" height="200" ></canvas>
        <script>
          //get the canvas
          var zoompan=new TerrainUI(document.getElementById('zoompan'));
          zoompan.addZoomPan();
        </script>
        <button onclick="zoompan.copyAndVisualizeHeightmap(transformations_coast)">Copy from Above</button>
      </div>
    </div>
  </body>
</html>